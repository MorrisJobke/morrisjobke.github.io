<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="chrome=1">
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Morris Jobke</title>
<link rel=stylesheet href=/css/pygment_trac.css?1628252514>
<link rel=alternate type=application/atom+xml title="Atom feed" href=/feed.xml>
<link rel=stylesheet href=/css/webfonts.css?1628252514>
<link rel=stylesheet href=/css/base.css?1628252514>
<meta property="og:title" content="My experience with NixOps">
<meta property="og:description" content="After my initial post about NixOps I gave it an in-depth try by migrating one of my servers that hosts a little private blog, a commenting system and some static website over to NixOps.
NixOS on Scaleway machine First I needed to get NixOS running on my Scaleway VPS. It&rsquo;s not supported out of the box but in the NixOps wiki there is a handy guide to accomplish this. It basically boils down to place a file /etc/nixos/host.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://morrisjobke.de/2021/02/21/my-experience-with-nixops/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-02-21T11:03:00+00:00">
<meta property="article:modified_time" content="2021-02-21T11:03:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="My experience with NixOps">
<meta name=twitter:description content="After my initial post about NixOps I gave it an in-depth try by migrating one of my servers that hosts a little private blog, a commenting system and some static website over to NixOps.
NixOS on Scaleway machine First I needed to get NixOS running on my Scaleway VPS. It&rsquo;s not supported out of the box but in the NixOps wiki there is a handy guide to accomplish this. It basically boils down to place a file /etc/nixos/host.">
<meta name=twitter:site content="@MorrisJobke">
<meta itemprop=name content="My experience with NixOps">
<meta itemprop=description content="After my initial post about NixOps I gave it an in-depth try by migrating one of my servers that hosts a little private blog, a commenting system and some static website over to NixOps.
NixOS on Scaleway machine First I needed to get NixOS running on my Scaleway VPS. It&rsquo;s not supported out of the box but in the NixOps wiki there is a handy guide to accomplish this. It basically boils down to place a file /etc/nixos/host."><meta itemprop=datePublished content="2021-02-21T11:03:00+00:00">
<meta itemprop=dateModified content="2021-02-21T11:03:00+00:00">
<meta itemprop=wordCount content="897">
<meta itemprop=keywords content>
</head>
<body>
<div class=header>
<div class=container>
<span class=name>Morris<b>Jobke</b></span>
<ul class=menu>
<li><a href=/>Articles</a></li> /
<li><a href=/emobility>E-mobility</a></li> /
<li><a href=/talks>Talks</a></li> /
<li><a href=/links>Links</a></li>
<li class=item-right><a href=/feed.xml><svg width="20" height="20" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M576 1344q0 80-56 136t-136 56-136-56-56-136 56-136 136-56 136 56 56 136zm512 123q2 28-17 48-18 21-47 21H889q-25 0-43-16.5t-20-41.5q-22-229-184.5-391.5T250 902q-25-2-41.5-20T192 839V704q0-29 21-47 17-17 43-17h5q160 13 306 80.5T826 902q114 113 181.5 259t80.5 306zm512 2q2 27-18 47-18 20-46 20h-143q-26 0-44.5-17.5T1329 1476q-12-215-101-408.5t-231.5-336-336-231.5T252 398q-25-1-42.5-19.5T192 335V192q0-28 20-46 18-18 44-18h3q262 13 501.5 120T1186 542q187 186 294 425.5t120 501.5z" fill="#fff"/></svg></a></li>
<li class=item-right><a href=https://twitter.com/MorrisJobke><svg width="20" height="20" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5T1369.5 1125 1185 1335.5t-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5T285 1033q33 5 61 5 43 0 85-11-112-23-185.5-111.5T172 710v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5T884 653q-8-38-8-74 0-134 94.5-228.5T1199 256q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z" fill="#fff"/></svg></a></li>
<li class=item-right><a href=https://github.com/MorrisJobke><svg width="20" height="20" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1664 896q0 251-146.5 451.5T1139 1625q-27 5-39.5-7t-12.5-30v-211q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105T1386 856q0-121-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27T578 459.5 492 446q-44 113-7 204-79 85-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-40 36-49 103-21 10-45 15t-57 5-65.5-21.5T484 1274q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 89t.5 54q0 18-13 30t-40 7q-232-77-378.5-277.5T128 896q0-209 103-385.5T510.5 231 896 128t385.5 103T1561 510.5 1664 896z" fill="#fff"/></svg></a></li>
</ul>
</div>
</div>
<div class=container>
<h1>My experience with NixOps <span class=meta>21 Feb 2021</span></h1>
<div id=post>
<p>After my <a href=/2021/01/05/first-steps-with-nixops/>initial post about NixOps</a> I gave it an in-depth try by migrating one of my servers that hosts a little private blog, a commenting system and some static website over to NixOps.</p>
<h2 id=nixos-on-scaleway-machine>NixOS on Scaleway machine</h2>
<p>First I needed to get NixOS running on my <a href=https://www.scaleway.com/>Scaleway</a> VPS. It&rsquo;s not supported out of the box but in the NixOps wiki there is a <a href=https://nixos.wiki/wiki/Install_NixOS_on_Scaleway_X86_Virtual_Cloud_Server>handy guide</a> to accomplish this. It basically boils down to place a file <code>/etc/nixos/host.nix</code> with the NixOS configuration and then use the <a href=https://github.com/elitak/nixos-infect>nixos-infext</a> script to transform the Ubuntu VM into an NixOS one by running following command:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl https://raw.githubusercontent.com/elitak/nixos-infect/master/nixos-infect |  NIXOS_IMPORT<span style=color:#f92672>=</span>./host.nix NIX_CHANNEL<span style=color:#f92672>=</span>nixos-20.09 bash 2&gt;&amp;<span style=color:#ae81ff>1</span> | tee /tmp/infect.log
</code></pre></div><p>The machine then reboots and you have a running NixOS system.</p>
<h2 id=bootstrap-nixops>Bootstrap NixOps</h2>
<p>After that I copied the configuration in <code>/etc/nixos</code> over to the machine that runs NixOps, because it overwrites the server completely. That should be three files: <code>hardware-configuration.nix</code>, <code>host.nix</code> and <code>configuration.nix</code>. I transfered them into one file and it looks like this:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix>{
  network <span style=color:#f92672>=</span> {
    description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Blog&#34;</span>;
    enableRollback <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
  };

  webserver <span style=color:#f92672>=</span>
    { config<span style=color:#f92672>,</span> pkgs<span style=color:#f92672>,</span> modulesPath<span style=color:#f92672>,</span> <span style=color:#f92672>...</span> }:
    { nixpkgs<span style=color:#f92672>.</span>localSystem<span style=color:#f92672>.</span>system <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;x86_64-linux&#34;</span>;
      deployment<span style=color:#f92672>.</span>targetHost <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;IP-ADDRESS&#34;</span>;

      <span style=color:#75715e># hardware-configuration.nix</span>
      imports <span style=color:#f92672>=</span> [ (modulesPath <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/profiles/qemu-guest.nix&#34;</span>) ];
      boot<span style=color:#f92672>.</span>loader<span style=color:#f92672>.</span>grub<span style=color:#f92672>.</span>device <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/dev/vda&#34;</span>;
      fileSystems<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>=</span> { device <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/dev/vda1&#34;</span>; fsType <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ext4&#34;</span>; };

      <span style=color:#75715e># configuration.nix</span>
      boot<span style=color:#f92672>.</span>cleanTmpDir <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
      networking<span style=color:#f92672>.</span>hostName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;scw-practical-euler&#34;</span>;
      networking<span style=color:#f92672>.</span>firewall<span style=color:#f92672>.</span>allowPing <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
      services<span style=color:#f92672>.</span>openssh<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
      users<span style=color:#f92672>.</span>users<span style=color:#f92672>.</span>root<span style=color:#f92672>.</span>openssh<span style=color:#f92672>.</span>authorizedKeys<span style=color:#f92672>.</span>keys <span style=color:#f92672>=</span> [
        <span style=color:#e6db74>&#34;ssh-ed25519 PUBLIC-KEY morris@laptop.local&#34;</span>
      ];

      <span style=color:#75715e># host.nix</span>
      services<span style=color:#f92672>.</span>caddy <span style=color:#f92672>=</span> {
        enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
        email <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;EMAIL-ADDRESS&#34;</span>;
        config <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span><span style=color:#e6db74>          (common) {
</span><span style=color:#e6db74>            encode gzip
</span><span style=color:#e6db74>            header / -Server
</span><span style=color:#e6db74>            header / -X-Powered-By
</span><span style=color:#e6db74>          }
</span><span style=color:#e6db74>          a.test.morrisjobke.de {
</span><span style=color:#e6db74>            reverse_proxy 127.0.0.1:2368
</span><span style=color:#e6db74>          }
</span><span style=color:#e6db74>          b.test.morrisjobke.de {
</span><span style=color:#e6db74>            root * /data/http
</span><span style=color:#e6db74>            import common
</span><span style=color:#e6db74>            file_server browse
</span><span style=color:#e6db74>          }
</span><span style=color:#e6db74>        &#39;&#39;</span>;
      };

      virtualisation<span style=color:#f92672>.</span>oci-containers <span style=color:#f92672>=</span> {
        backend <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;podman&#34;</span>;
        containers <span style=color:#f92672>=</span> {
          ghost <span style=color:#f92672>=</span> {
            image <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ghost:3-alpine&#34;</span>;
            ports <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;127.0.0.1:2368:2368&#34;</span>];
            volumes <span style=color:#f92672>=</span> [
              <span style=color:#e6db74>&#34;/data/blog:/var/lib/ghost/content&#34;</span>
            ];
            environment <span style=color:#f92672>=</span> {
              url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://a.test.morrisjobke.de&#34;</span>;
            };
          };
        };
      };

      <span style=color:#75715e># ... further config ...</span>
    };
}
</code></pre></div><h2 id=initial-deploy>Initial deploy</h2>
<p>Then one can create the server inside NixOps and deploy it:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>nixops create ./scaleway-setup.nix -d scaleway-staging
nixops deploy -d scaleway-staging
</code></pre></div><h3 id=potential-deployment-problems>Potential deployment problems</h3>
<p>On my initial deployment it had problems to build the system. That is because it does a ssh connection on the server to itself. Usually it places a public ssh key in the server configuration, but in my case it failed with something like this:</p>
<pre><code>cannot build on 'ssh://root@12.34.56.78': cannot connect to 'root@12.34.56.78': Permission denied, please try again.
Received disconnect from 12.34.56.78 port 22:2: Too many authentication failures
Disconnected from 12.34.56.78 port 22
error: a 'x86_64-linux' with features {} is required to build '/nix/store/ir75vkqa6jz7scjgvn1bb7lm1p2z0wl5-kernel-modules.drv', but I am a 'x86_64-darwin' with features {benchmark, big-parallel, nixos-test}
</code></pre><p>I looked on my NixOps host into the SQLite db at <code>~/.nixops/deployments.nixops</code> and extracted the public key (attribute with the name <code>none.sshPublicKey</code> inside the table <code>ResourceAttrs</code>) and placed it as public key for the user root (see <code>users.users.root.openssh.authorizedKeys.keys</code>).</p>
<h2 id=rollbacks>Rollbacks</h2>
<p>The option <code>network.enableRollback = true</code> allows rollbacks from within NixOps.</p>
<pre><code>$ nixops list-generations -d scaleway-staging
   1   2021-02-19 20:56:40   
   2   2021-02-19 20:58:00   (current)
</code></pre><p>Those can be selected via <code>nixops-rollback</code>:</p>
<p><img src=/images/2021-02-21-nixops-rollback.png alt></p>
<h2 id=drawbacks-of-nixops>Drawbacks of Nixops</h2>
<h3 id=secrets>Secrets</h3>
<p>If one places secrets inside the Nix configuration those will result in specific builds of those on the server itself in <code>/nix/store</code> (like <code>/nix/store/7i9f023yvfm3b03kq2khl1djh8wrpb5z-caddy-config.json</code>). All of the files in there are readable on the server by any user.</p>
<p><a href=https://releases.nixos.org/nixops/nixops-1.7/manual/manual.html#idm140737322342384>The NixOps manual also highlights</a> this and provides a way (<code>deployment.keys.&lt;name></code>) to store secrets inside a temporary file system that has proper access rights and is bundled with systemd services that indicate that those files are there so that the actual service can rely on that properly and allows tracing back why a service fails. Unfortunately that also means that a reboot of the server that is not invoked via <code>nixops</code> will result in the secrets not being available and need to be deployed again via <code>nixops</code>.</p>
<h3 id=nixpkgs-channel>Nixpkgs channel</h3>
<p>NixOps itself deploys the packages based on a channel, but it does not use the channel configured on the server, but the channel configured on the machine where NixOps runs. So you need to be careful what you run there. I configured my laptop to use the latest release, because I noticed that on MacOS by default it uses the unstable channel that then also got deployed to the server, which is most likely not wanted. I changed it from</p>
<pre><code>nixpkgs https://nixos.org/channels/nixpkgs-unstable
</code></pre><p>to</p>
<pre><code>nixpkgs https://nixos.org/channels/nixpkgs-20.09-darwin
</code></pre><p>via the <code>nix-channels</code> command.</p>
<p>There is an <a href=https://github.com/NixOS/nixops/issues/736>open issue on GitHub</a> about this to properly distinguish between the channels on the server and the nixops machine.</p>
<h3 id=automaticunattended-upgrades>Automatic/unattended upgrades</h3>
<p>The configuration of the system is not copied over to the server itself and therefore one cannot run <code>nixos-rebuild switch --upgrade</code> on the server. Also the <code>system.autoUpgrade.enable</code> option does not work, because it uses this command. There is an <a href=https://github.com/NixOS/nixops/issues/842>open issue on GitHub</a> about this as well.</p>
<h2 id=conclusion>Conclusion</h2>
<p>I really like to be able to quickly bootstrap a system. It allows to easily setup a staging environment that is really the same as the production one (or vice versa). Due to the drawbacks of NixOps I will look into an easier approach of managing remote machines as I barely need the majority of the features of NixOps and an <code>rsync</code> of the configuration to the server combined with an <code>nixos-rebuild</code> via <code>ssh</code> should solve 2 of the 3 drawbacks I ran into.</p>
<h2 id=useful-resources>Useful resources</h2>
<ul>
<li><a href="https://search.nixos.org/options?channel=20.09&from=0&size=50&sort=relevance&query=systemd.services.%3Cname%3E">NixOS options search</a></li>
<li><a href=https://noqqe.de/sammelsurium/nixos/>NixOS Sammelsurium by noqqe</a></li>
<li><a href=https://noqqe.de/blog/2021/02/06/nextcloud-mit-nixos-containers/>Example of using Podman (as Docker runtime alternative) by noqqe</a></li>
</ul>
</div>
</div>
<div class="container footer">
Morris Jobke - <a rel=license href=http://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0 International License</a>
</div>
</body>
</html>