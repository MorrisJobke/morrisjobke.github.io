<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><title>Morris Jobke</title><link rel=stylesheet href=/css/pygment_trac.css?1666873593><link rel=alternate type=application/atom+xml title="Atom feed" href=/feed.xml><link rel=stylesheet href=/css/webfonts.css?1666873593><link rel=stylesheet href=/css/base.css?1666873593><meta property="og:title" content="CouchDB - filtered replication by example"><meta property="og:description" content="I just want to document what is needed to get a filtered replication between two databases inside CouchDB 2.2.0 up and running. I spend quite some time figuring it out and couldn&rsquo;t find any useful resource that sums it up.
I used capital cased names where specific names need to be placed - if there is the same placeholder it needs to be the same name.
The goal is to replicate SOURCE_DATABASE to TARGET_DATABASE while applying a filter function that is named DESIGNDOCUMENT/NAME."><meta property="og:type" content="article"><meta property="og:url" content="https://morrisjobke.de/2018/10/31/couchdb-replication/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-10-31T21:53:00+00:00"><meta property="article:modified_time" content="2018-10-31T21:53:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="CouchDB - filtered replication by example"><meta name=twitter:description content="I just want to document what is needed to get a filtered replication between two databases inside CouchDB 2.2.0 up and running. I spend quite some time figuring it out and couldn&rsquo;t find any useful resource that sums it up.
I used capital cased names where specific names need to be placed - if there is the same placeholder it needs to be the same name.
The goal is to replicate SOURCE_DATABASE to TARGET_DATABASE while applying a filter function that is named DESIGNDOCUMENT/NAME."><meta name=twitter:site content="@MorrisJobke"><meta itemprop=name content="CouchDB - filtered replication by example"><meta itemprop=description content="I just want to document what is needed to get a filtered replication between two databases inside CouchDB 2.2.0 up and running. I spend quite some time figuring it out and couldn&rsquo;t find any useful resource that sums it up.
I used capital cased names where specific names need to be placed - if there is the same placeholder it needs to be the same name.
The goal is to replicate SOURCE_DATABASE to TARGET_DATABASE while applying a filter function that is named DESIGNDOCUMENT/NAME."><meta itemprop=datePublished content="2018-10-31T21:53:00+00:00"><meta itemprop=dateModified content="2018-10-31T21:53:00+00:00"><meta itemprop=wordCount content="276"><meta itemprop=keywords content></head><body><div class=header><div class=container><span class=name>Morris<b>Jobke</b></span><ul class=menu><li><a href=/>Articles</a></li>/<li><a href=/emobility>E-mobility</a></li>/<li><a href=/talks>Talks</a></li>/<li><a href=/links>Links</a></li><li class=item-right><a href=/feed.xml><svg width="20" height="20" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M576 1344q0 80-56 136t-136 56-136-56-56-136 56-136 136-56 136 56 56 136zm512 123q2 28-17 48-18 21-47 21H889q-25 0-43-16.5t-20-41.5q-22-229-184.5-391.5T250 902q-25-2-41.5-20T192 839V704q0-29 21-47 17-17 43-17h5q160 13 306 80.5T826 902q114 113 181.5 259t80.5 306zm512 2q2 27-18 47-18 20-46 20h-143q-26 0-44.5-17.5T1329 1476q-12-215-101-408.5t-231.5-336-336-231.5T252 398q-25-1-42.5-19.5T192 335V192q0-28 20-46 18-18 44-18h3q262 13 501.5 120T1186 542q187 186 294 425.5t120 501.5z" fill="#fff"/></svg></a></li><li class=item-right><a href=https://twitter.com/MorrisJobke><svg width="20" height="20" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5T1369.5 1125 1185 1335.5t-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5T285 1033q33 5 61 5 43 0 85-11-112-23-185.5-111.5T172 710v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5T884 653q-8-38-8-74 0-134 94.5-228.5T1199 256q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z" fill="#fff"/></svg></a></li><li class=item-right><a href=https://github.com/MorrisJobke><svg width="20" height="20" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1664 896q0 251-146.5 451.5T1139 1625q-27 5-39.5-7t-12.5-30v-211q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105T1386 856q0-121-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27T578 459.5 492 446q-44 113-7 204-79 85-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-40 36-49 103-21 10-45 15t-57 5-65.5-21.5T484 1274q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 89t.5 54q0 18-13 30t-40 7q-232-77-378.5-277.5T128 896q0-209 103-385.5T510.5 231 896 128t385.5 103T1561 510.5 1664 896z" fill="#fff"/></svg></a></li></ul></div></div><div class=container><h1>CouchDB - filtered replication by example <span class=meta>31 Oct 2018</span></h1><div id=post><p>I just want to document what is needed to get a filtered replication between two databases inside CouchDB 2.2.0 up and running. I spend quite some time figuring it out and couldn&rsquo;t find any useful resource that sums it up.</p><p>I used capital cased names where specific names need to be placed - if there is the same placeholder it needs to be the same name.</p><p>The goal is to replicate <code>SOURCE_DATABASE</code> to <code>TARGET_DATABASE</code> while applying a filter function that is named <code>DESIGNDOCUMENT/NAME</code>. The filter function in the example checks if the attribute <code>_id</code> starts with <code>abc</code>.</p><p>First we create a document that describes the filter. This document is a design document and needs to be placed in the source database under <code>/SOURCE_DATABASE/_design/DESIGNDOCUMENT</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;_id&#34;</span>: <span style=color:#e6db74>&#34;_design/DESIGNDOCUMENT&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;filters&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;NAME&#34;</span>: <span style=color:#e6db74>&#34;function(doc, req) { if (doc._id.substr(0, 3) === &#39;abc&#39;) { return true; } return false; }&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To actually test the filter I used a query against the <code>/_changes</code> endpoint of the database:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl <span style=color:#e6db74>&#34;http://DOMAIN:5984/SOURCE_DATABASE/_changes?filter=DESIGNDOCUMENT%2FNAME&amp;feed=normal&amp;style=all_docs&amp;since=0&amp;timeout=10000&#34;</span>
</span></span></code></pre></div><p>This shows the output and potential errors in the JavaScript code of the filter.</p><p>For the actual replication you need to create following documents in the <code>_replicator</code> database for the one time replication of existing documents:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;_id&#34;</span>: <span style=color:#e6db74>&#34;ID&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;source&#34;</span>: <span style=color:#e6db74>&#34;http://DOMAIN:5984/SOURCE_DATABASE&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;target&#34;</span>: <span style=color:#e6db74>&#34;http://DOMAIN:5984/TARGET_DATABASE&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;filter&#34;</span>: <span style=color:#e6db74>&#34;DESIGNDOCUMENT/NAME&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And I created a continuous replication document as well:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;_id&#34;</span>: <span style=color:#e6db74>&#34;ID-continuous&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;source&#34;</span>: <span style=color:#e6db74>&#34;http://DOMAIN:5984/SOURCE_DATABASE&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;target&#34;</span>: <span style=color:#e6db74>&#34;http://DOMAIN:5984/TARGET_DATABASE&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;filter&#34;</span>: <span style=color:#e6db74>&#34;DESIGNDOCUMENT/NAME&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;continuous&#34;</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Following documentation pages helped me to understand how the replication works in general:</p><ul><li><a href=http://docs.couchdb.org/en/stable/replication/intro.html>Introduction to Replication</a></li><li><a href=http://docs.couchdb.org/en/stable/replication/replicator.html>Replicator Database</a></li><li><a href=http://docs.couchdb.org/en/stable/ddocs/ddocs.html#filterfun>Filter function documents</a></li></ul><p>Quite interesting in this regard could also be the blog post <a href=https://pouchdb.com/2015/04/05/filtered-replication.html>&ldquo;Filtered replication: from Couch to Pouch and back</a> at the PouchDB blog.</p></div></div><div class="container footer">Morris Jobke - <a rel=license href=http://creativecommons.org/licenses/by/4.0/>Creative Commons Attribution 4.0 International License</a></div></body></html>